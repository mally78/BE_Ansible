---
- hosts: server
  remote_user: root
  
  tasks:
  
  - name: get groups
    win_command: Get-Content C:\Scripts\userimport.csv
    register: userimport_out

  - name: Ensure users are present with address information
    win_domain_user: >
      name: {{ lookup('csvfile', item + ' file=userimport.csv col=0 delimiter=,') }}
      firstname: Bob
      surname: Smith
      company: BobCo
      password: B0bP4ssw0rd
      state: present
      groups:
        - Domain Admins
      street: 123 4th St.
      city: Sometown
      state_province: IN
      postal_code: 12345
      country: US
    with_items: "{{ userimport_out.stdout_lines }}"
    ignore_errors: True
